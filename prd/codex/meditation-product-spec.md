# 冥想功能产品说明

## 目标
为已拥有功德币体系的冥想场景提供可配置、可订阅、可追溯的体验，满足以下诉求：
- 用户可设置冥想时长、是否伴随木鱼敲击及敲击频率。
- 冥想结束后能保存心情与领悟，并生成系统化的昵称与功德标签。
- 通过功德币订阅控制功能开通与有效期，支持日/周/月三种套餐。
- 输出当日、历史、月度冥想统计，供用户复盘成长轨迹。

## 核心流程
1. **订阅购买**
   - 用户选择套餐：1 功德币/天、5 功德币/周、15 功德币/月。
   - 成功扣币后生成订阅记录，若已有在有效期内的订阅，则新订阅在原到期时间上顺延。
   - 记录钱包流水，便于对账与退款。

2. **冥想开始**
   - 前端提交计划时长、是否伴随敲击、敲击频率。
   - 服务端校验订阅是否有效，创建冥想会话草稿，返回 `sessionId`。
   - 同时刷新用户默认配置（方便下一次默认加载）。

3. **冥想结束**
   - 用户填写心情与一段领悟语句，提交实际时长。
   - 系统保存会话数据，自动产生命名与功德标签。
   - 更新每日统计（次数、总时长、最近心情与领悟）以及总览数据。

4. **冥想放弃**
   - 若用户选择不保存，可调用放弃接口，标记会话为丢弃状态，不参与统计。

5. **统计与配置**
   - 提供今日/累计概况（次数、时长）。
   - 按月返回每日冥想记录，包括时长、心情、领悟。
   - 用户可随时获取或修改默认冥想配置（时长、敲击偏好）。

## 数据设计概览
- `t_meditation_session`：记录单次冥想会话（计划/实际时长、敲击配置、心情、领悟、支付状态）。
- `t_meditation_daily_stats`：冥想每日汇总，用于快速统计今日与月度数据。
- `t_meditation_subscription`：订阅记录，存储套餐、有效期、扣币金额及关联的流水 ID。
- `t_meditation_user_pref`：用户默认配置，记录常用时长与敲击偏好。
- `t_merit_coin_transaction`：功德币流水，记录每次订阅扣费及余额。

## 接口概要
- `POST /meditation/subscription/purchase`：购买/续费订阅。
- `GET /meditation/subscription/status`：查询当前订阅状态、剩余时长与功德币余额。
- `POST /meditation/session/start`：校验订阅并创建冥想会话。
- `POST /meditation/session/finish`：保存冥想结果，更新统计。
- `POST /meditation/session/discard`：丢弃会话草稿。
- `GET /meditation/stats/summary`：个人今日及累计数据的概览。
- `GET /meditation/stats/month`：月度每天的冥想时长/心情/领悟。
- `GET /meditation/config/default` / `PUT /meditation/config/default`：读取与更新默认冥想设置。

## 权限与校验
- **登录前提**：冥想功能依赖平台既有的登录/注册流程，用户头像、昵称等信息沿用 `User`、`UserStats` 数据；接口必须验证登录态。
- 订阅、冥想会话接口在调用前需检查用户是否已通过实名/基础资料（头像、昵称）初始化，缺失时提示前往个人中心完善。
- 对于功德币余额不足或订阅失效的情况，需要在接口返回明确错误码与提示语，前端据此引导充值或续费。
- 冥想开始、结束流程使用用户级锁，避免多端同时操作造成数据错乱。
- 订阅状态在每次调用时自动刷新过期标记，确保有效期准确。

## 用户信息与展示
- 头像、昵称：统一读取用户资料中心（沿用现有“用户档案”接口），冥想记录列表展示时带出头像和系统生成的冥想昵称。
- 自动生成昵称/功德标签：后端在冥想完成时根据规则写入会话记录，前端无需参与；建议预留文案配置表以便运营调整。
- 若用户未设置头像或昵称，前端可落地默认头像/昵称，同时后台在冥想结果中写入生成值，保证冥想分享页面展示完整。

## 状态与通知（可选拓展）
- 若后续需要实时反馈冥想进度，可复用现有 WebSocket 通道，推送心情或冥想状态。
- 可在订阅即将到期时通过消息中心通知用户续费。

## 验收要点
- 在未订阅或过期状态下，冥想开始接口应明确拒绝。
- 订阅续费后，应延长到期时间且留存扣币流水。
- 冥想结束后，统计接口可立即反映当日及累计时长/次数变化。
- 默认配置更新应同步影响下一次冥想开始的预填值。
